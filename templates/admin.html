{% extends "base.html" %}

{% block content %}
<nav class="user-nav admin-nav">
    <div class="logo">
        <span class="admin-badge">üëë</span>
        Admin Dashboard
    </div>
    <div class="user-info">
        <span class="username">{{ current_user.username }}</span>
        <span class="admin-label">Administrator</span>
    </div>
    <a href="{{ url_for('logout') }}" class="logout-btn">
        <span>üö™</span> Logout
    </a>
</nav>

<div class="admin-tabs">
    <button class="tab-btn active" onclick="showTab('modify-game')">
        <span class="tab-icon">üéÆ</span>
        Game Settings
    </button>
    <button class="tab-btn" onclick="showTab('users')">
        <span class="tab-icon">üë•</span>
        User Management
    </button>
    <button class="tab-btn" onclick="showTab('analytics')">
        <span class="tab-icon">üìä</span>
        Analytics
    </button>
</div>

<div class="admin-container">
    <!-- Modify Game Tab -->
    <div id="modify-game" class="tab-content active">
        <div class="panel modern-panel">
            <div class="panel-header">
                <h3>üé≤ Game Configuration</h3>
                <p class="panel-description">Adjust probability weights for each number. Higher weights increase the chance of that number appearing.</p>
            </div>
            
            <div class="weights-grid">
                {% for i in range(13) %}
                <div class="weight-card {% if i == 0 %}green-number{% elif i in [1,3,5,7,9,11] %}red-number{% else %}black-number{% endif %}">
                    <div class="number-label">{{ i }}</div>
                    <input type="number" class="weight-val modern-input" data-number="{{ i }}" value="{{ weights[i] }}" min="0" max="100">
                    <div class="weight-label">Weight</div>
                </div>
                {% endfor %}
            </div>
            
            <div class="toggle-box modern-toggle">
                <label class="switch">
                    <input type="checkbox" id="use-tweaked" {% if use_tweaked %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
                <div class="toggle-text">
                    <strong>Tweaked Mode</strong>
                    <span class="toggle-desc">Enable custom weights in live game</span>
                </div>
            </div>
            
            <div class="button-group modern-buttons">
                <button onclick="saveSettings()" class="btn-modern btn-primary">
                    <span>üíæ</span> Save Settings
                </button>
                <button onclick="resetGame()" class="btn-modern btn-warning">
                    <span>‚Üª</span> Reset to Fair
                </button>
                <button onclick="tryGame()" class="btn-modern btn-info">
                    <span>üé∞</span> Test Game
                </button>
            </div>
        </div>

        <div class="panel modern-panel">
            <div class="panel-header">
                <h3>üìà Monte Carlo Simulation</h3>
                <p class="panel-description">Compare expected outcomes between fair and tweaked probability models.</p>
            </div>
            
            <div class="sim-controls">
                <div class="input-group-modern">
                    <label for="sim-runs">Simulation Runs</label>
                    <input type="number" id="sim-runs" value="10000" min="100" max="1000000" step="1000">
                </div>
                <button onclick="runSimulation()" class="btn-modern btn-primary">
                    <span>‚ñ∂</span> Run Simulation
                </button>
            </div>
            
            <div id="sim-results" class="sim-results" style="display:none;">
                <h4 class="results-title">Simulation Results</h4>
                <div class="results-cards">
                    <div class="result-card fair-card">
                        <h5>Fair Model</h5>
                        <div class="stat">
                            <span class="stat-label">Total Bet</span>
                            <span class="stat-value" id="fair-bet">-</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">House Profit</span>
                            <span class="stat-value" id="fair-profit">-</span>
                        </div>
                        <div class="stat highlight">
                            <span class="stat-label">House Edge</span>
                            <span class="stat-value" id="fair-edge">-</span>
                        </div>
                    </div>
                    
                    <div class="result-card tweaked-card">
                        <h5>Tweaked Model</h5>
                        <div class="stat">
                            <span class="stat-label">Total Bet</span>
                            <span class="stat-value" id="tweaked-bet">-</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">House Profit</span>
                            <span class="stat-value" id="tweaked-profit">-</span>
                        </div>
                        <div class="stat highlight">
                            <span class="stat-label">House Edge</span>
                            <span class="stat-value" id="tweaked-edge">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content">
        <div class="panel modern-panel">
            <div class="panel-header">
                <h3>üí∞ Pending Money Requests</h3>
                <p class="panel-description">Review and manage user funding requests.</p>
            </div>
            {% if pending_requests %}
            <div class="table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in pending_requests %}
                        <tr id="request-{{ req.id }}">
                            <td>
                                <div class="user-cell">
                                    <span class="user-avatar">üë§</span>
                                    {{ req.user.username }}
                                </div>
                            </td>
                            <td class="amount-cell">${{ "%.2f"|format(req.amount) }}</td>
                            <td class="date-cell">{{ req.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td class="action-cell">
                                <button onclick="handleRequest({{ req.id }}, 'approve')" class="btn-modern btn-success btn-sm">
                                    <span>‚úì</span> Approve
                                </button>
                                <button onclick="handleRequest({{ req.id }}, 'reject')" class="btn-modern btn-danger btn-sm">
                                    <span>‚úó</span> Reject
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <span class="empty-icon">üì≠</span>
                <p>No pending requests</p>
            </div>
            {% endif %}
        </div>

        <div class="panel modern-panel">
            <div class="panel-header">
                <h3>üë• User Management</h3>
                <p class="panel-description">Manage user balances and accounts.</p>
            </div>
            <div class="table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Balance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr id="user-{{ user.id }}">
                            <td>
                                <div class="user-cell">
                                    <span class="user-avatar">üë§</span>
                                    {{ user.username }}
                                </div>
                            </td>
                            <td>
                                <div class="balance-input-group">
                                    <span class="currency-symbol">$</span>
                                    <input type="number" id="balance-{{ user.id }}" class="modern-input balance-input" value="{{ user.balance }}" step="0.01">
                                </div>
                            </td>
                            <td class="action-cell">
                                <button onclick="updateBalance({{ user.id }})" class="btn-modern btn-primary btn-sm">
                                    <span>üíæ</span> Update
                                </button>
                                <button onclick="deleteUser({{ user.id }})" class="btn-modern btn-danger btn-sm">
                                    <span>üóë</span> Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Analytics Tab (New) -->
    <div id="analytics" class="tab-content">
        <div class="panel modern-panel">
            <div class="panel-header">
                <h3>üìä System Analytics</h3>
                <p class="panel-description">Overview of system performance and user activity.</p>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <div class="stat-value">{{ users|length }}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-info">
                        <div class="stat-value">{{ pending_requests|length }}</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéÆ</div>
                    <div class="stat-info">
                        <div class="stat-value">{% if use_tweaked %}Tweaked{% else %}Fair{% endif %}</div>
                        <div class="stat-label">Game Mode</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíµ</div>
                    <div class="stat-info">
                        <div class="stat-value">${{ "%.2f"|format(users|sum(attribute='balance')) if users else '0.00' }}</div>
                        <div class="stat-label">Total User Balance</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Toast Notification System
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    async function saveSettings() {
        const weights = [];
        document.querySelectorAll('.weight-val').forEach(input => {
            weights.push(parseInt(input.value));
        });
        const useTweaked = document.getElementById('use-tweaked').checked;

        const response = await fetch('/admin/update_settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ weights, use_tweaked: useTweaked })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('‚öôÔ∏è Game settings saved successfully!', 'success');
        }
    }

    async function resetGame() {
        if (!confirm('Reset all settings to fair mode? This will set all weights to 1.')) return;

        const response = await fetch('/admin/reset_game', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('üîÑ Game reset to fair mode!', 'success');
            setTimeout(() => location.reload(), 1500);
        }
    }

    function tryGame() {
        window.open('/game', '_blank');
        showToast('Opening game in new window...', 'info');
    }

    async function runSimulation() {
        const runs = document.getElementById('sim-runs').value;
        const btn = event.target;
        btn.disabled = true;
        btn.innerText = 'Running...';
        
        showToast(`üé≤ Running ${runs} simulations...`, 'info');

        const response = await fetch('/admin/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ n_runs: runs })
        });
        
        const data = await response.json();
        
        document.getElementById('fair-bet').innerText = data.fair.total_bet;
        document.getElementById('fair-profit').innerText = data.fair.house_profit.toFixed(2);
        document.getElementById('fair-edge').innerText = data.fair.house_edge_percent.toFixed(2) + '%';
        
        document.getElementById('tweaked-bet').innerText = data.tweaked.total_bet;
        document.getElementById('tweaked-profit').innerText = data.tweaked.house_profit.toFixed(2);
        document.getElementById('tweaked-edge').innerText = data.tweaked.house_edge_percent.toFixed(2) + '%';
        
        document.getElementById('sim-results').style.display = 'block';
        btn.disabled = false;
        btn.innerText = 'Run Simulation';
        
        showToast('‚úÖ Simulation complete!', 'success');
    }

    async function handleRequest(requestId, action) {
        const response = await fetch(`/admin/handle_request/${requestId}/${action}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast(data.message, action === 'approve' ? 'success' : 'warning');
            document.getElementById(`request-${requestId}`).remove();
        } else {
            showToast(data.error || 'Operation failed', 'error');
        }
    }

    async function updateBalance(userId) {
        const newBalance = document.getElementById(`balance-${userId}`).value;
        
        const response = await fetch('/admin/update_balance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: userId, balance: parseFloat(newBalance) })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('üí∞ User balance updated successfully!', 'success');
        } else {
            showToast(data.error || 'Update failed', 'error');
        }
    }

    async function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

        const response = await fetch(`/admin/delete_user/${userId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('üóëÔ∏è User deleted successfully!', 'warning');
            document.getElementById(`user-${userId}`).remove();
        } else {
            showToast(data.error || 'Deletion failed', 'error');
        }
    }
</script>
{% endblock %}
