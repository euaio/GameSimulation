{% extends "base.html" %}

{% block content %}
<nav class="user-nav admin-nav">
    <div class="logo">
        <span class="admin-badge">üëë</span>
        Admin Dashboard
    </div>
    <div class="user-info">
        <span class="username">{{ current_user.username }}</span>
        <span class="admin-label">Administrator</span>
    </div>
    <a href="{{ url_for('logout') }}" class="logout-btn">
        Logout
    </a>
</nav>

<div class="admin-tabs">
    <button class="tab-btn active" onclick="showTab('modify-game')">
        <span class="tab-icon">üéÆ</span>
        Game Settings
    </button>
    <button class="tab-btn" onclick="showTab('users')">
        <span class="tab-icon">üë•</span>
        User Management
    </button>
    <button class="tab-btn" onclick="showTab('analytics')">
        <span class="tab-icon">üìä</span>
        Analytics
    </button>
</div>

<div class="admin-container">
    <!-- Modify Game Tab -->
    <div id="modify-game" class="tab-content active">
        <div class="panel modern-panel">
            <div class="panel-header">
                <h3>üé≤ Game Configuration</h3>
                <p class="panel-description">Adjust probability percentages for each number. Other probabilities auto-adjust to maintain 100% total.</p>
            </div>
            
            <div class="weights-grid">
                {% for i in range(13) %}
                <div class="weight-card {% if i == 0 %}green-number{% elif i in [1,3,5,7,9,11] %}red-number{% else %}black-number{% endif %}">
                    <div class="number-label">{{ i }}</div>
                    <input type="range" class="weight-slider" data-number="{{ i }}" value="7.69" min="0" max="50" step="0.1" oninput="updateWeightFromSlider({{ i }})">
                    <input type="number" class="weight-val modern-input" id="weight-input-{{ i }}" data-number="{{ i }}" value="7.69" min="0" max="100" step="0.01" oninput="updateWeightFromInput({{ i }})">
                    <div class="weight-label">%</div>
                </div>
                {% endfor %}
            </div>

            <div class="prob-summary">
                <h4>Probability Distribution Summary</h4>
                <div class="summary-stats">
                    <div class="summary-stat green-stat">
                        <span class="stat-icon">üü¢</span>
                        <div class="stat-info">
                            <span class="stat-name">Green (0)</span>
                            <span class="stat-percent" id="admin-green-total">7.69%</span>
                        </div>
                    </div>
                    <div class="summary-stat red-stat">
                        <span class="stat-icon">üî¥</span>
                        <div class="stat-info">
                            <span class="stat-name">Red (1,3,5,7,9,11)</span>
                            <span class="stat-percent" id="admin-red-total">46.14%</span>
                        </div>
                    </div>
                    <div class="summary-stat black-stat">
                        <span class="stat-icon">‚ö´</span>
                        <div class="stat-info">
                            <span class="stat-name">Black (2,4,6,8,10,12)</span>
                            <span class="stat-percent" id="admin-black-total">46.14%</span>
                        </div>
                    </div>
                    <div class="summary-stat odd-stat">
                        <span class="stat-icon">üî¢</span>
                        <div class="stat-info">
                            <span class="stat-name">Odd (1,3,5,7,9,11)</span>
                            <span class="stat-percent" id="admin-odd-total">46.14%</span>
                        </div>
                    </div>
                    <div class="summary-stat even-stat">
                        <span class="stat-icon">üî¢</span>
                        <div class="stat-info">
                            <span class="stat-name">Even (2,4,6,8,10,12)</span>
                            <span class="stat-percent" id="admin-even-total">46.14%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="toggle-box modern-toggle">
                <label class="switch">
                    <input type="checkbox" id="use-tweaked" {% if use_tweaked %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
                <div class="toggle-text">
                    <strong>Tweaked Mode</strong>
                    <span class="toggle-desc">Enable custom probabilities in live game</span>
                </div>
            </div>
            
            <div class="button-group modern-buttons">
                <button onclick="saveSettings()" class="btn-modern btn-primary">
                     Save Settings
                </button>
                <button onclick="resetGame()" class="btn-modern btn-warning">
                    <span>‚Üª</span> Reset to Fair
                </button>
                <button onclick="adminLockProbs()" class="btn-modern btn-secondary" id="admin-lock-btn">
                    üîì Lock Distribution
                </button>
                <button onclick="tryGame()" class="btn-modern btn-info">
                     Test Game
                </button>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content">
        <div class="panel modern-panel">
            <div class="panel-header">
                <h3>üí∞ Pending Money Requests</h3>
                <p class="panel-description">Review and manage user funding requests.</p>
            </div>
            {% if pending_requests %}
            <div class="table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in pending_requests %}
                        <tr id="request-{{ req.id }}">
                            <td>
                                <div class="user-cell">
                                    <span class="user-avatar">üë§</span>
                                    {{ req.user.username }}
                                </div>
                            </td>
                            <td class="amount-cell">${{ "%.2f"|format(req.amount) }}</td>
                            <td class="date-cell">{{ req.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td class="action-cell">
                                <button onclick="handleRequest({{ req.id }}, 'approve')" class="btn-modern btn-success btn-sm">
                                    <span>‚úì</span> Approve
                                </button>
                                <button onclick="handleRequest({{ req.id }}, 'reject')" class="btn-modern btn-danger btn-sm">
                                    <span>‚úó</span> Reject
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <span class="empty-icon">üì≠</span>
                <p>No pending requests</p>
            </div>
            {% endif %}
        </div>

        <div class="panel modern-panel">
            <div class="panel-header">
                <h3>üë• User Management</h3>
                <p class="panel-description">Manage user balances and accounts.</p>
            </div>
            <div class="table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Balance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr id="user-{{ user.id }}">
                            <td>
                                <div class="user-cell">
                                    <span class="user-avatar">üë§</span>
                                    {{ user.username }}
                                </div>
                            </td>
                            <td>
                                <div class="balance-input-group">
                                    <span class="currency-symbol">$</span>
                                    <input type="number" id="balance-{{ user.id }}" class="modern-input balance-input" value="{{ user.balance }}" step="0.01">
                                </div>
                            </td>
                            <td class="action-cell">
                                <button onclick="updateBalance({{ user.id }})" class="btn-modern btn-primary btn-sm">
                                    Update
                                </button>
                                <button onclick="deleteUser({{ user.id }})" class="btn-modern btn-danger btn-sm">
                                    <span>üóë</span> Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Analytics Tab (New) -->
    <div id="analytics" class="tab-content">
        <div class="panel modern-panel">
            <div class="panel-header">
                <h3>üìä System Analytics</h3>
                <p class="panel-description">Overview of system performance and user activity.</p>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <div class="stat-value">{{ users|length }}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-info">
                        <div class="stat-value">{{ pending_requests|length }}</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéÆ</div>
                    <div class="stat-info">
                        <div class="stat-value">{% if use_tweaked %}Tweaked{% else %}Fair{% endif %}</div>
                        <div class="stat-label">Game Mode</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíµ</div>
                    <div class="stat-info">
                        <div class="stat-value">${{ "%.2f"|format(users|sum(attribute='balance')) if users else '0.00' }}</div>
                        <div class="stat-label">Total User Balance</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Toast Notification System
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    // Admin weight management with auto-adjustment
    let adminIsLocked = false;

    function updateWeightFromSlider(number) {
        const slider = document.querySelector(`.weight-slider[data-number="${number}"]`);
        const input = document.getElementById(`weight-input-${number}`);
        const newValue = parseFloat(slider.value);
        
        input.value = newValue.toFixed(2);
        
        if (!adminIsLocked) {
            redistributeWeights(number, newValue);
        }
        updateAdminSummaryStats();
    }

    function updateWeightFromInput(number) {
        const input = document.getElementById(`weight-input-${number}`);
        const slider = document.querySelector(`.weight-slider[data-number="${number}"]`);
        let newValue = parseFloat(input.value) || 0;
        
        if (newValue > 100) newValue = 100;
        if (newValue < 0) newValue = 0;
        
        input.value = newValue.toFixed(2);
        slider.value = Math.min(newValue, 50);
        
        if (!adminIsLocked) {
            redistributeWeights(number, newValue);
        }
        updateAdminSummaryStats();
    }

    function redistributeWeights(changedNumber, newValue) {
        const weights = {};
        let otherTotal = 0;
        
        for (let i = 0; i <= 12; i++) {
            if (i === changedNumber) {
                weights[i] = newValue;
            } else {
                const input = document.getElementById(`weight-input-${i}`);
                weights[i] = parseFloat(input.value) || 0;
                otherTotal += weights[i];
            }
        }
        
        const remaining = 100 - newValue;
        
        if (remaining < 0 || otherTotal === 0) {
            for (let i = 0; i <= 12; i++) {
                if (i !== changedNumber) {
                    const input = document.getElementById(`weight-input-${i}`);
                    const slider = document.querySelector(`.weight-slider[data-number="${i}"]`);
                    input.value = '0.00';
                    slider.value = '0';
                }
            }
        } else {
            const scaleFactor = remaining / otherTotal;
            
            for (let i = 0; i <= 12; i++) {
                if (i !== changedNumber) {
                    const newWeight = weights[i] * scaleFactor;
                    const input = document.getElementById(`weight-input-${i}`);
                    const slider = document.querySelector(`.weight-slider[data-number="${i}"]`);
                    input.value = newWeight.toFixed(2);
                    slider.value = Math.min(newWeight, 50).toFixed(2);
                }
            }
        }
    }

    function updateAdminSummaryStats() {
        const redNumbers = [1, 3, 5, 7, 9, 11];
        const blackNumbers = [2, 4, 6, 8, 10, 12];
        const oddNumbers = [1, 3, 5, 7, 9, 11];
        const evenNumbers = [2, 4, 6, 8, 10, 12];
        
        let greenTotal = parseFloat(document.getElementById('weight-input-0').value) || 0;
        let redTotal = 0;
        let blackTotal = 0;
        let oddTotal = 0;
        let evenTotal = 0;
        
        for (let i = 1; i <= 12; i++) {
            const weight = parseFloat(document.getElementById(`weight-input-${i}`).value) || 0;
            
            if (redNumbers.includes(i)) redTotal += weight;
            if (blackNumbers.includes(i)) blackTotal += weight;
            if (oddNumbers.includes(i)) oddTotal += weight;
            if (evenNumbers.includes(i)) evenTotal += weight;
        }
        
        document.getElementById('admin-green-total').textContent = greenTotal.toFixed(2) + '%';
        document.getElementById('admin-red-total').textContent = redTotal.toFixed(2) + '%';
        document.getElementById('admin-black-total').textContent = blackTotal.toFixed(2) + '%';
        document.getElementById('admin-odd-total').textContent = oddTotal.toFixed(2) + '%';
        document.getElementById('admin-even-total').textContent = evenTotal.toFixed(2) + '%';
    }

    function adminLockProbs() {
        adminIsLocked = !adminIsLocked;
        const btn = document.getElementById('admin-lock-btn');
        
        if (adminIsLocked) {
            btn.innerHTML = 'üîí Unlock Distribution';
            btn.classList.add('locked');
            showToast('Auto-adjustment disabled. Manual control enabled.', 'info');
        } else {
            btn.innerHTML = 'üîì Lock Distribution';
            btn.classList.remove('locked');
            showToast('Auto-adjustment enabled.', 'info');
        }
    }

    // Initialize weights from server data
    function initializeWeights() {
        const serverWeights = {{ weights | tojson }};
        
        // Convert weights to percentages
        const totalWeight = serverWeights.reduce((a, b) => a + b, 0);
        
        for (let i = 0; i <= 12; i++) {
            const percentage = (serverWeights[i] / totalWeight * 100);
            const input = document.getElementById(`weight-input-${i}`);
            const slider = document.querySelector(`.weight-slider[data-number="${i}"]`);
            
            input.value = percentage.toFixed(2);
            slider.value = Math.min(percentage, 50).toFixed(2);
        }
        
        updateAdminSummaryStats();
    }

    // Call on page load
    document.addEventListener('DOMContentLoaded', initializeWeights);

    async function saveSettings() {
        const percentages = [];
        document.querySelectorAll('.weight-val').forEach(input => {
            percentages.push(parseFloat(input.value));
        });
        
        // Convert percentages to weights (proportional values)
        const weights = percentages.map(p => Math.round(p * 100));
        const useTweaked = document.getElementById('use-tweaked').checked;

        const response = await fetch('/admin/update_settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ weights, use_tweaked: useTweaked })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('‚öôÔ∏è Game settings saved successfully!', 'success');
        }
    }

    async function resetGame() {
        if (!confirm('Reset all settings to fair mode? This will set all weights to 1.')) return;

        const response = await fetch('/admin/reset_game', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('üîÑ Game reset to fair mode!', 'success');
            setTimeout(() => location.reload(), 1500);
        }
    }

    function tryGame() {
        window.open('/game', '_blank');
        showToast('Opening game in new window...', 'info');
    }

    async function handleRequest(requestId, action) {
        const response = await fetch(`/admin/handle_request/${requestId}/${action}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast(data.message, action === 'approve' ? 'success' : 'warning');
            document.getElementById(`request-${requestId}`).remove();
        } else {
            showToast(data.error || 'Operation failed', 'error');
        }
    }

    async function updateBalance(userId) {
        const newBalance = document.getElementById(`balance-${userId}`).value;
        
        const response = await fetch('/admin/update_balance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: userId, balance: parseFloat(newBalance) })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('üí∞ User balance updated successfully!', 'success');
        } else {
            showToast(data.error || 'Update failed', 'error');
        }
    }

    async function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

        const response = await fetch(`/admin/delete_user/${userId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('üóëÔ∏è User deleted successfully!', 'warning');
            document.getElementById(`user-${userId}`).remove();
        } else {
            showToast(data.error || 'Deletion failed', 'error');
        }
    }
</script>
{% endblock %}
