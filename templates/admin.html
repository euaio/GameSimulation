{% extends "base.html" %}

{% block content %}
<nav class="user-nav">
    <div class="logo">Admin Dashboard</div>
    <div class="user-info">
        <span class="username">Admin</span>
    </div>
    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
</nav>

<div class="admin-tabs">
    <button class="tab-btn active" onclick="showTab('modify-game')">Modify Game</button>
    <button class="tab-btn" onclick="showTab('users')">Users</button>
</div>

<div class="admin-container">
    <!-- Modify Game Tab -->
    <div id="modify-game" class="tab-content active">
        <div class="panel">
            <h3>Game Configuration (Tweaked Mode)</h3>
            <p>Adjust the weights for each number (Default Fair is 1 for all).</p>
            <div class="weights-form">
                {% for i in range(13) %}
                <div class="weight-input">
                    <label>{{ i }}:</label>
                    <input type="number" class="weight-val" data-number="{{ i }}" value="{{ weights[i] }}" min="0">
                </div>
                {% endfor %}
            </div>
            
            <div class="toggle-box">
                <label>
                    <input type="checkbox" id="use-tweaked" {% if use_tweaked %}checked{% endif %}>
                    Enable Tweaked Mode for Live Game
                </label>
            </div>
            
            <div class="button-group">
                <button onclick="saveSettings()">Save Settings</button>
                <button onclick="resetGame()" class="btn-warning">Reset to Fair</button>
                <button onclick="tryGame()" class="btn-secondary">Try Game</button>
            </div>
        </div>

        <div class="panel">
            <h3>Monte Carlo Simulation</h3>
            <p>Run 10,000 iterations of Fair vs. Tweaked models.</p>
            <label>Number of Runs: <input type="number" id="sim-runs" value="10000"></label>
            <button onclick="runSimulation()">Run Simulation</button>
            
            <div id="sim-results" style="display:none; margin-top: 20px;">
                <h4>Results</h4>
                <table border="1" cellpadding="5">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Fair Model</th>
                            <th>Tweaked Model</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Total Bet</td>
                            <td id="fair-bet"></td>
                            <td id="tweaked-bet"></td>
                        </tr>
                        <tr>
                            <td>House Profit</td>
                            <td id="fair-profit"></td>
                            <td id="tweaked-profit"></td>
                        </tr>
                        <tr>
                            <td>House Edge %</td>
                            <td id="fair-edge"></td>
                            <td id="tweaked-edge"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content">
        <div class="panel">
            <h3>Pending Money Requests</h3>
            {% if pending_requests %}
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in pending_requests %}
                    <tr id="request-{{ req.id }}">
                        <td>{{ req.user.username }}</td>
                        <td>${{ "%.2f"|format(req.amount) }}</td>
                        <td>{{ req.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <button onclick="handleRequest({{ req.id }}, 'approve')" class="btn-success">Approve</button>
                            <button onclick="handleRequest({{ req.id }}, 'reject')" class="btn-danger">Reject</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No pending requests</p>
            {% endif %}
        </div>

        <div class="panel">
            <h3>All Users</h3>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr id="user-{{ user.id }}">
                        <td>{{ user.username }}</td>
                        <td>
                            <input type="number" id="balance-{{ user.id }}" value="{{ user.balance }}" step="0.01">
                        </td>
                        <td>
                            <button onclick="updateBalance({{ user.id }})" class="btn-primary">Update</button>
                            <button onclick="deleteUser({{ user.id }})" class="btn-danger">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Toast Notification System
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    async function saveSettings() {
        const weights = [];
        document.querySelectorAll('.weight-val').forEach(input => {
            weights.push(parseInt(input.value));
        });
        const useTweaked = document.getElementById('use-tweaked').checked;

        const response = await fetch('/admin/update_settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ weights, use_tweaked: useTweaked })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('‚öôÔ∏è Game settings saved successfully!', 'success');
        }
    }

    async function resetGame() {
        if (!confirm('Reset all settings to fair mode? This will set all weights to 1.')) return;

        const response = await fetch('/admin/reset_game', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('üîÑ Game reset to fair mode!', 'success');
            setTimeout(() => location.reload(), 1500);
        }
    }

    function tryGame() {
        window.open('/game', '_blank');
        showToast('Opening game in new window...', 'info');
    }

    async function runSimulation() {
        const runs = document.getElementById('sim-runs').value;
        const btn = event.target;
        btn.disabled = true;
        btn.innerText = 'Running...';
        
        showToast(`üé≤ Running ${runs} simulations...`, 'info');

        const response = await fetch('/admin/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ n_runs: runs })
        });
        
        const data = await response.json();
        
        document.getElementById('fair-bet').innerText = data.fair.total_bet;
        document.getElementById('fair-profit').innerText = data.fair.house_profit.toFixed(2);
        document.getElementById('fair-edge').innerText = data.fair.house_edge_percent.toFixed(2) + '%';
        
        document.getElementById('tweaked-bet').innerText = data.tweaked.total_bet;
        document.getElementById('tweaked-profit').innerText = data.tweaked.house_profit.toFixed(2);
        document.getElementById('tweaked-edge').innerText = data.tweaked.house_edge_percent.toFixed(2) + '%';
        
        document.getElementById('sim-results').style.display = 'block';
        btn.disabled = false;
        btn.innerText = 'Run Simulation';
        
        showToast('‚úÖ Simulation complete!', 'success');
    }

    async function handleRequest(requestId, action) {
        const response = await fetch(`/admin/handle_request/${requestId}/${action}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast(data.message, action === 'approve' ? 'success' : 'warning');
            document.getElementById(`request-${requestId}`).remove();
        } else {
            showToast(data.error || 'Operation failed', 'error');
        }
    }

    async function updateBalance(userId) {
        const newBalance = document.getElementById(`balance-${userId}`).value;
        
        const response = await fetch('/admin/update_balance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: userId, balance: parseFloat(newBalance) })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('üí∞ User balance updated successfully!', 'success');
        } else {
            showToast(data.error || 'Update failed', 'error');
        }
    }

    async function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

        const response = await fetch(`/admin/delete_user/${userId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            showToast('üóëÔ∏è User deleted successfully!', 'warning');
            document.getElementById(`user-${userId}`).remove();
        } else {
            showToast(data.error || 'Deletion failed', 'error');
        }
    }
</script>
{% endblock %}
